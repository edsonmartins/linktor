(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8269],{5256:(e,s,n)=>{Promise.resolve().then(n.bind(n,3996))},3996:(e,s,n)=>{"use strict";n.r(s),n.d(s,{default:()=>V});var t=n(95155),a=n(12115),r=n(39556),l=n(20853),c=n(84267),i=n(63348),o=n(75231),d=n(33900),u=n(73312),x=n(25121),m=n(35055),h=n(77995),f=n(87081),v=n(57485),g=n(21567),j=n(85534),p=n(61556),N=n(86435),y=n(35906),b=n(25848),w=n(66889),_=n(98867),E=n(64906),S=n(61594),A=n(43831),k=n(47820),C=n(1466),T=n(51055),R=n(15015),H=n(65843),I=n(28283),z=n(35996),F=n(31836),O=n(15157),P=n(53601),W=n(97007),D=n(59974);function U(e){let{status:s}=e;switch(s){case"pending":return(0,t.jsx)(w.A,{className:"h-3 w-3 text-muted-foreground"});case"sent":return(0,t.jsx)(_.A,{className:"h-3 w-3 text-muted-foreground"});case"delivered":return(0,t.jsx)(E.A,{className:"h-3 w-3 text-muted-foreground"});case"read":return(0,t.jsx)(E.A,{className:"h-3 w-3 text-primary"});case"failed":return(0,t.jsx)(S.A,{className:"h-3 w-3 text-destructive"});default:return null}}function q(e){let{message:s,isOwn:n}=e;return(0,t.jsxs)("div",{className:(0,g.cn)("flex gap-2 max-w-[70%]",n?"ml-auto flex-row-reverse":""),children:[!n&&(0,t.jsx)(m.e,{fallback:"contact"===s.sender_type?"C":"S",size:"sm"}),(0,t.jsxs)("div",{className:(0,g.cn)("space-y-1",n&&"items-end"),children:[(0,t.jsx)("div",{className:(0,g.cn)("rounded-lg px-3 py-2",n?"message-outgoing":"message-incoming"),children:(0,t.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:s.content})}),(0,t.jsxs)("div",{className:(0,g.cn)("flex items-center gap-1 text-[10px] text-muted-foreground",n&&"justify-end"),children:[(0,t.jsx)("span",{children:(0,g.fw)(s.created_at)}),n&&(0,t.jsx)(U,{status:s.status})]})]})]})}function K(e){var s,n,a,r,l,c;let{conversation:i}=e;return(0,t.jsxs)("div",{className:"flex h-16 items-center justify-between border-b border-border bg-card px-4",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)(m.e,{fallback:(null===(s=i.contact)||void 0===s?void 0:s.name)||"U",status:"open"===i.status?"online":"offline"}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h2",{className:"font-medium",children:(null===(n=i.contact)||void 0===n?void 0:n.name)||"Unknown Contact"}),(0,t.jsxs)("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[(0,t.jsx)(x.E,{variant:(null===(a=i.channel)||void 0===a?void 0:a.type)||"secondary",className:"text-[10px] px-1.5 py-0",children:null===(r=i.channel)||void 0===r?void 0:r.type}),(0,t.jsx)("span",{children:(null===(l=i.contact)||void 0===l?void 0:l.phone)||(null===(c=i.contact)||void 0===c?void 0:c.email)||"No contact info"})]})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)(P.S9,{content:"Voice call",children:(0,t.jsx)(u.$,{variant:"ghost",size:"icon",children:(0,t.jsx)(A.A,{className:"h-4 w-4"})})}),(0,t.jsx)(P.S9,{content:"Video call",children:(0,t.jsx)(u.$,{variant:"ghost",size:"icon",children:(0,t.jsx)(k.A,{className:"h-4 w-4"})})}),(0,t.jsx)(P.S9,{content:"Contact info",children:(0,t.jsx)(u.$,{variant:"ghost",size:"icon",children:(0,t.jsx)(C.A,{className:"h-4 w-4"})})}),(0,t.jsxs)(v.rI,{children:[(0,t.jsx)(v.ty,{asChild:!0,children:(0,t.jsx)(u.$,{variant:"ghost",size:"icon",children:(0,t.jsx)(T.A,{className:"h-4 w-4"})})}),(0,t.jsxs)(v.SQ,{align:"end",children:[(0,t.jsx)(v._2,{children:"Resolve conversation"}),(0,t.jsx)(v._2,{children:"Assign to agent"}),(0,t.jsx)(v._2,{children:"Snooze"}),(0,t.jsx)(v.mB,{}),(0,t.jsx)(v._2,{className:"text-destructive",children:"Delete conversation"})]})]})]})]})}function M(e){let{typingUsers:s}=e;if(0===s.length)return null;let n=s.map(e=>e.user_name||"Someone").join(", ");return(0,t.jsxs)("div",{className:"flex items-center gap-2 px-4 py-2 text-xs text-muted-foreground animate-pulse",children:[(0,t.jsxs)("div",{className:"flex gap-1",children:[(0,t.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-muted-foreground animate-bounce [animation-delay:-0.3s]"}),(0,t.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-muted-foreground animate-bounce [animation-delay:-0.15s]"}),(0,t.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-muted-foreground animate-bounce"})]}),(0,t.jsxs)("span",{children:[n," ",1===s.length?"is":"are"," typing..."]})]})}function L(e){let{conversationId:s,onSend:n,onTyping:r,isSending:l}=e,[c,i]=(0,a.useState)(""),o=(0,a.useRef)(null),x=e=>{e.preventDefault(),c.trim()&&!l&&(r(!1),n(c.trim()),i(""))};return(0,t.jsx)("form",{onSubmit:x,className:"border-t border-border bg-card p-4",children:(0,t.jsxs)("div",{className:"flex items-end gap-2",children:[(0,t.jsx)(P.S9,{content:"Attach file",children:(0,t.jsx)(u.$,{type:"button",variant:"ghost",size:"icon",children:(0,t.jsx)(R.A,{className:"h-5 w-5"})})}),(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsx)(d.p,{placeholder:"Type a message...",value:c,onChange:e=>{i(e.target.value),r(!0),o.current&&clearTimeout(o.current),o.current=setTimeout(()=>{r(!1)},2e3)},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),x(e))},variant:"terminal",className:"min-h-[40px]"})}),(0,t.jsx)(P.S9,{content:"Emoji",children:(0,t.jsx)(u.$,{type:"button",variant:"ghost",size:"icon",children:(0,t.jsx)(H.A,{className:"h-5 w-5"})})}),(0,t.jsx)(u.$,{type:"submit",size:"icon",disabled:!c.trim()||l,loading:l,children:(0,t.jsx)(I.A,{className:"h-5 w-5"})})]})})}function $(e){let{conversationId:s}=e,n=(0,y.jE)(),l=(0,W.Jd)(),c=(0,a.useRef)(null),[i,o]=(0,a.useState)([]),{connectionState:d,subscribe:u,sendTyping:x}=(0,D.Iw)(),{data:m,isLoading:v}=(0,r.I)({queryKey:p.lH.conversations.detail(s),queryFn:()=>j.FH.get("/conversations/".concat(s))}),{data:N,isLoading:w}=(0,r.I)({queryKey:p.lH.messages.list(s),queryFn:()=>j.FH.get("/conversations/".concat(s,"/messages"))}),_=(null==N?void 0:N.data)||[],E=(0,b.n)({mutationFn:e=>j.FH.post("/conversations/".concat(s,"/messages"),{content:e,content_type:"text"}),onSuccess:()=>{n.invalidateQueries({queryKey:p.lH.messages.list(s)}),n.invalidateQueries({queryKey:p.lH.conversations.detail(s)})}}),S=(0,a.useCallback)(e=>{x(s,e)},[s,x]);return((0,a.useEffect)(()=>{let e=u(D.y1.NEW_MESSAGE,e=>{e.conversation_id===s&&(n.invalidateQueries({queryKey:p.lH.messages.list(s)}),n.invalidateQueries({queryKey:p.lH.conversations.detail(s)}))}),t=u(D.y1.TYPING,e=>{e.conversation_id===s&&o(s=>e.is_typing?s.find(s=>s.user_id===e.user_id)?s:[...s,{user_id:e.user_id,user_name:e.user_name}]:s.filter(s=>s.user_id!==e.user_id))});return()=>{e(),t()}},[s,u,n]),(0,a.useEffect)(()=>{var e;null===(e=c.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[_]),v)?(0,t.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,t.jsxs)("div",{className:"flex h-16 items-center gap-3 border-b border-border bg-card px-4",children:[(0,t.jsx)(f.EA,{className:"h-10 w-10 rounded-full"}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(f.EA,{className:"h-4 w-32"}),(0,t.jsx)(f.EA,{className:"h-3 w-24"})]})]}),(0,t.jsx)("div",{className:"flex-1 p-4 space-y-4",children:Array.from({length:5}).map((e,s)=>(0,t.jsxs)("div",{className:(0,g.cn)("flex gap-2",s%2==0?"":"justify-end"),children:[s%2==0&&(0,t.jsx)(f.EA,{className:"h-8 w-8 rounded-full"}),(0,t.jsx)(f.EA,{className:(0,g.cn)("h-16 rounded-lg",s%2==0?"w-48":"w-56")})]},s))})]}):m?(0,t.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,t.jsx)(K,{conversation:m}),"connected"!==d&&(0,t.jsx)("div",{className:(0,g.cn)("flex items-center justify-center gap-2 py-1 text-xs","connecting"===d||"reconnecting"===d?"bg-yellow-500/10 text-yellow-500":"bg-destructive/10 text-destructive"),children:"connecting"===d||"reconnecting"===d?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(z.A,{className:"h-3 w-3 animate-pulse"}),(0,t.jsx)("span",{children:"Connecting..."})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(F.A,{className:"h-3 w-3"}),(0,t.jsx)("span",{children:"Disconnected - Messages may be delayed"})]})}),(0,t.jsx)(h.F,{className:"flex-1 bg-background",children:(0,t.jsxs)("div",{className:"p-4 space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(O.w,{className:"flex-1"}),(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:(0,g.Yq)(m.created_at)}),(0,t.jsx)(O.w,{className:"flex-1"})]}),w?Array.from({length:5}).map((e,s)=>(0,t.jsxs)("div",{className:(0,g.cn)("flex gap-2",s%2==0?"":"justify-end"),children:[s%2==0&&(0,t.jsx)(f.EA,{className:"h-8 w-8 rounded-full"}),(0,t.jsx)(f.EA,{className:(0,g.cn)("h-16 rounded-lg",s%2==0?"w-48":"w-56")})]},s)):_.length>0?_.map(e=>(0,t.jsx)(q,{message:e,isOwn:"user"===e.sender_type&&e.sender_id===(null==l?void 0:l.id)},e.id)):(0,t.jsxs)("div",{className:"py-8 text-center text-muted-foreground",children:[(0,t.jsx)("p",{className:"text-sm",children:"No messages yet"}),(0,t.jsx)("p",{className:"text-xs",children:"Start the conversation by sending a message"})]}),(0,t.jsx)("div",{ref:c})]})}),(0,t.jsx)(M,{typingUsers:i}),(0,t.jsx)(L,{conversationId:s,onSend:e=>E.mutate(e),onTyping:S,isSending:E.isPending})]}):(0,t.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,t.jsx)("p",{className:"text-muted-foreground",children:"Conversation not found"})})}let G=[{label:"All",value:"all"},{label:"Open",value:"open"},{label:"Pending",value:"pending"},{label:"Resolved",value:"resolved"},{label:"Snoozed",value:"snoozed"}];function Q(e){var s,n,a,r,l;let{conversation:c,isActive:i,onClick:o}=e;return(0,t.jsxs)("button",{onClick:o,className:(0,g.cn)("flex w-full items-start gap-3 rounded-lg p-3 text-left transition-colors",i?"bg-primary/10 border border-primary/30":"hover:bg-secondary/50"),children:[(0,t.jsx)(m.e,{fallback:(null===(s=c.contact)||void 0===s?void 0:s.name)||"U",size:"default",status:"open"===c.status?"online":"offline"}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,t.jsx)("span",{className:"font-medium truncate",children:(null===(n=c.contact)||void 0===n?void 0:n.name)||"Unknown Contact"}),(0,t.jsx)("span",{className:"text-xs text-muted-foreground shrink-0",children:c.last_message_at?(0,g.fw)(c.last_message_at):"-"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 mt-1",children:[(0,t.jsx)(x.E,{variant:(null===(a=c.channel)||void 0===a?void 0:a.type)||"secondary",className:"text-[10px] px-1.5 py-0",children:(null===(r=c.channel)||void 0===r?void 0:r.type)||"unknown"}),(0,t.jsx)(x.E,{variant:{open:"success",pending:"warning",resolved:"info",snoozed:"secondary"}[c.status],className:"text-[10px] px-1.5 py-0",children:c.status})]}),(0,t.jsx)("p",{className:"mt-1 text-xs text-muted-foreground truncate",children:(null===(l=c.last_message)||void 0===l?void 0:l.content)?(0,g.xv)(c.last_message.content,50):"No messages yet"})]}),c.unread_count&&c.unread_count>0&&(0,t.jsx)("span",{className:"flex h-5 w-5 items-center justify-center rounded-full bg-primary text-[10px] font-bold text-primary-foreground",children:c.unread_count>9?"9+":c.unread_count})]})}function V(){let[e,s]=(0,a.useState)(""),[n,m]=(0,a.useState)("all"),y=(0,N.VC)(),b=(0,N.j_)(e=>e.setActiveConversation),{data:w,isLoading:_}=(0,r.I)({queryKey:p.lH.conversations.list({search:e,status:n}),queryFn:()=>j.FH.get("/conversations",{...e&&{search:e},..."all"!==n&&{status:n}})}),E=(null==w?void 0:w.data)||[];return(0,t.jsxs)("div",{className:"flex h-full",children:[(0,t.jsxs)("div",{className:"flex w-80 flex-col border-r border-border bg-card",children:[(0,t.jsx)(o.Y,{title:"Conversations"}),(0,t.jsxs)("div",{className:"border-b border-border p-3 space-y-2",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(d.p,{placeholder:"Search conversations...",value:e,onChange:e=>s(e.target.value),leftIcon:(0,t.jsx)(l.A,{className:"h-4 w-4"}),className:"flex-1"}),(0,t.jsxs)(v.rI,{children:[(0,t.jsx)(v.ty,{asChild:!0,children:(0,t.jsx)(u.$,{variant:"outline",size:"icon",children:(0,t.jsx)(c.A,{className:"h-4 w-4"})})}),(0,t.jsxs)(v.SQ,{align:"end",children:[(0,t.jsx)(v.lp,{children:"Filter by Status"}),(0,t.jsx)(v.mB,{}),G.map(e=>(0,t.jsx)(v._2,{onClick:()=>m(e.value),className:(0,g.cn)(n===e.value&&"bg-primary/10 text-primary"),children:e.label},e.value))]})]})]}),"all"!==n&&(0,t.jsx)("div",{className:"flex items-center gap-2",children:(0,t.jsxs)(x.E,{variant:"outline",className:"gap-1",children:["Status: ",n,(0,t.jsx)("button",{onClick:()=>m("all"),className:"ml-1 hover:text-foreground",children:"\xd7"})]})})]}),(0,t.jsx)(h.F,{className:"flex-1",children:(0,t.jsx)("div",{className:"p-2 space-y-1",children:_?Array.from({length:8}).map((e,s)=>(0,t.jsxs)("div",{className:"flex items-start gap-3 p-3",children:[(0,t.jsx)(f.EA,{className:"h-10 w-10 rounded-full"}),(0,t.jsxs)("div",{className:"flex-1 space-y-2",children:[(0,t.jsx)(f.EA,{className:"h-4 w-32"}),(0,t.jsx)(f.EA,{className:"h-3 w-24"}),(0,t.jsx)(f.EA,{className:"h-3 w-48"})]})]},s)):E.length>0?E.map(e=>(0,t.jsx)(Q,{conversation:e,isActive:y===e.id,onClick:()=>b(e.id)},e.id)):(0,t.jsxs)("div",{className:"py-12 text-center text-muted-foreground",children:[(0,t.jsx)(i.A,{className:"mx-auto h-8 w-8 opacity-50"}),(0,t.jsx)("p",{className:"mt-2 text-sm",children:"No conversations found"}),(0,t.jsx)("p",{className:"text-xs",children:"Start a new conversation or adjust filters"})]})})})]}),(0,t.jsx)("div",{className:"flex-1 flex flex-col",children:y?(0,t.jsx)($,{conversationId:y}):(0,t.jsx)("div",{className:"flex-1 flex items-center justify-center bg-background",children:(0,t.jsxs)("div",{className:"text-center text-muted-foreground",children:[(0,t.jsx)(i.A,{className:"mx-auto h-12 w-12 opacity-50"}),(0,t.jsx)("p",{className:"mt-4 text-lg font-medium",children:"Select a conversation"}),(0,t.jsx)("p",{className:"text-sm",children:"Choose a conversation from the list to start chatting"})]})})})]})}},15157:(e,s,n)=>{"use strict";n.d(s,{w:()=>c});var t=n(95155),a=n(12115),r=n(90434),l=n(21567);let c=a.forwardRef((e,s)=>{let{className:n,orientation:a="horizontal",decorative:c=!0,...i}=e;return(0,t.jsx)(r.b,{ref:s,decorative:c,orientation:a,className:(0,l.cn)("shrink-0 bg-border","horizontal"===a?"h-[1px] w-full":"h-full w-[1px]",n),...i})});c.displayName=r.b.displayName},59974:(e,s,n)=>{"use strict";n.d(s,{Iw:()=>d,fJ:()=>o,y1:()=>c});var t=n(95155),a=n(12115),r=n(85534);let l=n(2818).env.NEXT_PUBLIC_WS_URL||"ws://localhost:8081/api/v1/ws",c={NEW_MESSAGE:"new_message",MESSAGE_UPDATED:"message_updated",CONVERSATION_UPDATED:"conversation_updated",CONVERSATION_CREATED:"conversation_created",TYPING:"typing",PRESENCE:"presence",ERROR:"error",CONNECTED:"connected"},i=(0,a.createContext)(null);function o(e){let{children:s}=e,n=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{autoConnect:s=!0,reconnectAttempts:n=5,reconnectInterval:t=3e3,onConnect:i,onDisconnect:o,onError:d}=e,u=(0,a.useRef)(null),x=(0,a.useRef)(0),m=(0,a.useRef)(null),h=(0,a.useRef)(new Map),[f,v]=(0,a.useState)("disconnected"),[g,j]=(0,a.useState)([]),p=(0,a.useCallback)((e,s)=>(h.current.has(e)||h.current.set(e,new Set),h.current.get(e).add(s),()=>{var n;null===(n=h.current.get(e))||void 0===n||n.delete(s)}),[]),N=(0,a.useCallback)((e,s)=>{let n=h.current.get(e);n&&n.forEach(e=>e(s))},[]),y=(0,a.useCallback)(e=>{var s;(null===(s=u.current)||void 0===s?void 0:s.readyState)===WebSocket.OPEN&&u.current.send(JSON.stringify(e))},[]),b=(0,a.useCallback)((e,s)=>{y({type:c.TYPING,payload:{conversation_id:e,is_typing:s}})},[y]),w=(0,a.useCallback)(()=>{var e;let s=r.HM.getAccessToken();if(!s){console.warn("[WebSocket] No auth token available");return}if((null===(e=u.current)||void 0===e?void 0:e.readyState)===WebSocket.OPEN)return;v("connecting");let a="".concat(l,"?token=").concat(encodeURIComponent(s));try{u.current=new WebSocket(a),u.current.onopen=()=>{console.log("[WebSocket] Connected"),v("connected"),x.current=0,null==i||i()},u.current.onmessage=e=>{try{let s=JSON.parse(e.data);if(s.type===c.CONNECTED){let e=s.payload;j(e.online_users||[])}if(s.type===c.PRESENCE){let e=s.payload;j(s=>"online"===e.status?s.includes(e.user_id)?s:[...s,e.user_id]:s.filter(s=>s!==e.user_id))}N(s.type,s.payload)}catch(e){console.error("[WebSocket] Failed to parse message:",e)}},u.current.onclose=()=>{console.log("[WebSocket] Disconnected"),v("disconnected"),null==o||o(),x.current<n&&(v("reconnecting"),x.current++,console.log("[WebSocket] Reconnecting (".concat(x.current,"/").concat(n,")...")),m.current=setTimeout(()=>{w()},t))},u.current.onerror=e=>{console.error("[WebSocket] Error:",e),null==d||d(e)}}catch(e){console.error("[WebSocket] Failed to connect:",e),v("disconnected")}},[n,t,i,o,d,N]),_=(0,a.useCallback)(()=>{m.current&&(clearTimeout(m.current),m.current=null),x.current=n,u.current&&(u.current.close(),u.current=null),v("disconnected")},[n]);return(0,a.useEffect)(()=>(s&&w(),()=>{_()}),[s,w,_]),{connectionState:f,onlineUsers:g,connect:w,disconnect:_,sendTyping:b,subscribe:p}}();return(0,t.jsx)(i.Provider,{value:n,children:s})}function d(){let e=(0,a.useContext)(i);if(!e)throw Error("useWebSocketContext must be used within a WebSocketProvider");return e}},97007:(e,s,n)=>{"use strict";n.d(s,{Jd:()=>c,nc:()=>l});var t=n(99827),a=n(60709),r=n(85534);let l=(0,t.v)()((0,a.Zr)((e,s)=>({user:null,isAuthenticated:!1,isLoading:!1,error:null,login:async(s,n)=>{e({isLoading:!0,error:null});try{let t=await r.FH.post("/auth/login",{email:s,password:n});r.HM.setTokens(t.access_token,t.refresh_token),e({user:t.user,isAuthenticated:!0,isLoading:!1})}catch(s){throw e({error:s instanceof Error?s.message:"Login failed",isLoading:!1,isAuthenticated:!1,user:null}),s}},logout:()=>{r.HM.clearTokens(),e({user:null,isAuthenticated:!1,error:null})},refreshToken:async()=>{let n=r.HM.getRefreshToken();if(!n){s().logout();return}try{let s=await r.FH.post("/auth/refresh",{refresh_token:n});r.HM.setTokens(s.access_token,s.refresh_token),e({user:s.user,isAuthenticated:!0})}catch(e){s().logout()}},setUser:s=>{e({user:s,isAuthenticated:!!s})},clearError:()=>{e({error:null})}}),{name:"auth-storage",storage:(0,a.KU)(()=>localStorage),partialize:e=>({user:e.user,isAuthenticated:e.isAuthenticated})})),c=()=>l(e=>e.user)}},e=>{var s=s=>e(e.s=s);e.O(0,[2361,8233,7778,6299,9556,3454,7866,6987,1667,5028,4580,6436,8441,1517,7358],()=>s(5256)),_N_E=e.O()}]);